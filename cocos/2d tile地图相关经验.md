# 记一次cocos2d tile地图开发经验
## 背景介绍
为一款2000年以前的游戏作手游复制。
地图使用的资源是64*48的图块，菱形，24位，没有ALPHA，四角用纯黑代表透明。
tile块共4500.
世界地图大小800*800

## 第一版实现
创建800*800个sprite, __每一个sprite对应创建一个shader__.
结果创建过程中就卡死了。

### 优化一
对地图进行裁剪。只创建等同于窗口可视数量的sprite.
在地图上移动的时候，删除不可视sprite,并创建新增sprite.
可以正常创建地图，但是移动时候会有黑边，并且明显**卡顿**。
tile与tile之间没有完整拼接，存在缝隙。

### 优化二
在可视窗口外再创建2圈缓冲tiles，移动黑边问题解决。

### 优化三
检查图元发现图元本身是可以无缝拼接的。
同时发现计算透明度的shader在部分单点纯黑处无法正常运行。
怀疑OPENGL管道在对象素进行了插值使其“失真”
查找相关资料发现cocos可以通过调Texture的setAliasTexParameters方法改变管线插值方式。
间隙问题解决。

## 第二版实现
发现之前shader没有复用的BUG，修正之。 然而卡顿依然明显。
打印UPDATE与RANDER用时发现主要是RENDER用时高。于是想到进行合图。
这里尝试了一下内存合图，在TextureCache类中创建了一个4096*4096的大texture BigTex。
然后每当加载新的tiles时，就转存到BigTex,然而绘制时候使用BigTex进行绘制。
每帧opengl api call顺利优化到100以内。
然而每次用尽缓冲tiles需要加载新tiles时依然会卡顿。

### 优化一
尝试调节缓冲tiles的宽度来缓解卡顿感，无效。

### 优化二
显然问题在于加载，所以进行预加载。
另外考虑到读取4500多个文件可能会比较费时，进行进行外部合图。
产生共13张1024*1024的资源。然后进入地图前先全部载入内存。
至此，基本总理解决。


## TODO
 * 没有确认读文件本身的性能情况，到底有多差
 * 内存合图在这里面并不是必须的，但对于某些不适合外部合图的场景来说是有用的，应该提取通用代码。
 * 地图合图后可以尝试进一步压缩。
 * 讨论非等大图元的合图算法。
 * 如果把合图texture设想为CPU的高速缓存的话，讨论图元进出texture的控制算法。
